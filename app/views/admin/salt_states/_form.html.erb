<% content_for :head do %>
  <!-- Monaco Editor -->
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.min.js"></script>
  <style>
    #editor-container {
      height: 500px;
      border: 1px solid hsl(var(--bc) / 0.2);
      border-radius: 0.5rem;
    }
  </style>
<% end %>

<%= form_with model: [:admin, salt_state], local: true, class: "space-y-6" do |f| %>
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Main Content -->
    <div class="lg:col-span-2 space-y-6">
      <!-- Name & Type -->
      <div class="card bg-base-100 shadow-sm">
        <div class="card-body">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="form-control">
              <label class="label">
                <span class="label-text font-medium">Name <span class="text-error">*</span></span>
              </label>
              <%= f.text_field :name, class: "input input-bordered #{salt_state.errors[:name].any? ? 'input-error' : ''}", placeholder: "e.g., webserver/nginx" %>
              <% if salt_state.errors[:name].any? %>
                <label class="label">
                  <span class="label-text-alt text-error"><%= salt_state.errors[:name].first %></span>
                </label>
              <% else %>
                <label class="label">
                  <span class="label-text-alt text-base-content/60">Use forward slashes for subdirectories (e.g., web/nginx)</span>
                </label>
              <% end %>
            </div>

            <div class="form-control">
              <label class="label">
                <span class="label-text font-medium">Type <span class="text-error">*</span></span>
              </label>
              <%= f.select :state_type, SaltState.state_types.keys.map { |t| [t.titleize, t] }, {}, class: "select select-bordered", id: "state_type_select" %>
            </div>
          </div>
        </div>
      </div>

      <!-- Code Editor -->
      <div class="card bg-base-100 shadow-sm">
        <div class="card-body p-0">
          <!-- Editor Header -->
          <div class="flex items-center justify-between px-4 py-2 bg-base-200 rounded-t-xl">
            <div class="flex items-center gap-2">
              <div class="flex gap-1.5">
                <div class="w-3 h-3 rounded-full bg-error"></div>
                <div class="w-3 h-3 rounded-full bg-warning"></div>
                <div class="w-3 h-3 rounded-full bg-success"></div>
              </div>
              <span class="font-mono text-sm text-base-content/60" id="file-path-preview">
                <%= salt_state.file_path || '/srv/salt/...' %>
              </span>
            </div>
            <div class="flex items-center gap-2">
              <span id="validation-status" class="badge badge-sm badge-ghost">
                <span class="loading loading-ring loading-xs mr-1"></span>
                Validating...
              </span>
            </div>
          </div>

          <!-- Monaco Editor Container -->
          <div id="editor-container"></div>

          <!-- Hidden textarea for form submission -->
          <%= f.hidden_field :content, id: "content_hidden" %>
        </div>
      </div>

      <!-- Validation Messages -->
      <div id="validation-messages" class="hidden">
        <div class="alert alert-error">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <div>
            <h3 class="font-bold">YAML Syntax Error</h3>
            <p class="text-sm" id="validation-error-message"></p>
          </div>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="space-y-4">
      <!-- Metadata -->
      <div class="card bg-base-100 shadow-sm">
        <div class="card-body">
          <h3 class="font-semibold text-base-content mb-3">Details</h3>

          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium">Category</span>
            </label>
            <%= f.select :category, SaltState::CATEGORIES.map { |c| [c.titleize, c] }, { include_blank: "Select category..." }, class: "select select-bordered select-sm" %>
          </div>

          <div class="form-control mt-4">
            <label class="label">
              <span class="label-text font-medium">Description</span>
            </label>
            <%= f.text_area :description, class: "textarea textarea-bordered textarea-sm", rows: 3, placeholder: "Brief description of what this state does..." %>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="card bg-base-100 shadow-sm">
        <div class="card-body">
          <h3 class="font-semibold text-base-content mb-3">Actions</h3>

          <div class="space-y-2">
            <%= f.submit salt_state.new_record? ? "Create State" : "Save Changes", class: "btn btn-primary w-full gap-2" %>

            <%= link_to admin_salt_states_path, class: "btn btn-ghost w-full" do %>
              Cancel
            <% end %>
          </div>
        </div>
      </div>

      <!-- Quick Templates -->
      <% if salt_state.new_record? %>
        <div class="card bg-base-100 shadow-sm">
          <div class="card-body">
            <h3 class="font-semibold text-base-content mb-3">Quick Insert</h3>
            <div class="flex flex-wrap gap-2">
              <button type="button" onclick="insertSnippet('pkg')" class="btn btn-xs btn-ghost">pkg.installed</button>
              <button type="button" onclick="insertSnippet('service')" class="btn btn-xs btn-ghost">service.running</button>
              <button type="button" onclick="insertSnippet('file')" class="btn btn-xs btn-ghost">file.managed</button>
              <button type="button" onclick="insertSnippet('cmd')" class="btn btn-xs btn-ghost">cmd.run</button>
              <button type="button" onclick="insertSnippet('user')" class="btn btn-xs btn-ghost">user.present</button>
            </div>
          </div>
        </div>
      <% end %>

      <!-- Help -->
      <div class="collapse collapse-arrow bg-base-100 shadow-sm">
        <input type="checkbox" />
        <div class="collapse-title font-semibold">
          Keyboard Shortcuts
        </div>
        <div class="collapse-content">
          <div class="text-sm space-y-1">
            <div class="flex justify-between">
              <span class="text-base-content/60">Save</span>
              <kbd class="kbd kbd-xs">Ctrl+S</kbd>
            </div>
            <div class="flex justify-between">
              <span class="text-base-content/60">Find</span>
              <kbd class="kbd kbd-xs">Ctrl+F</kbd>
            </div>
            <div class="flex justify-between">
              <span class="text-base-content/60">Replace</span>
              <kbd class="kbd kbd-xs">Ctrl+H</kbd>
            </div>
            <div class="flex justify-between">
              <span class="text-base-content/60">Undo</span>
              <kbd class="kbd kbd-xs">Ctrl+Z</kbd>
            </div>
            <div class="flex justify-between">
              <span class="text-base-content/60">Redo</span>
              <kbd class="kbd kbd-xs">Ctrl+Y</kbd>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
<% end %>

<script>
  let editor;
  let validationTimeout;

  // Initialize Monaco Editor
  require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' } });

  require(['vs/editor/editor.main'], function () {
    // Tokyo Night theme
    monaco.editor.defineTheme('tokyo-night', {
      base: 'vs-dark',
      inherit: true,
      rules: [
        { token: 'comment', foreground: '565f89', fontStyle: 'italic' },
        { token: 'keyword', foreground: '9d7cd8' },
        { token: 'string', foreground: '9ece6a' },
        { token: 'number', foreground: 'ff9e64' },
        { token: 'type', foreground: '2ac3de' }
      ],
      colors: {
        'editor.background': '#1a1b26',
        'editor.foreground': '#a9b1d6',
        'editorLineNumber.foreground': '#3b4261',
        'editorCursor.foreground': '#c0caf5',
        'editor.selectionBackground': '#33467c',
        'editor.lineHighlightBackground': '#1e2030'
      }
    });

    editor = monaco.editor.create(document.getElementById('editor-container'), {
      value: document.getElementById('content_hidden').value || '',
      language: 'yaml',
      theme: 'tokyo-night',
      minimap: { enabled: false },
      fontSize: 14,
      fontFamily: 'JetBrains Mono, Menlo, Monaco, Consolas, monospace',
      lineNumbers: 'on',
      renderWhitespace: 'selection',
      scrollBeyondLastLine: false,
      automaticLayout: true,
      tabSize: 2,
      insertSpaces: true,
      wordWrap: 'on'
    });

    // Sync editor content to hidden field
    editor.onDidChangeModelContent(() => {
      document.getElementById('content_hidden').value = editor.getValue();
      scheduleValidation();
    });

    // Save shortcut
    editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS, function () {
      document.querySelector('form').submit();
    });

    // Initial validation
    validateContent();
  });

  // Validation
  function scheduleValidation() {
    clearTimeout(validationTimeout);
    validationTimeout = setTimeout(validateContent, 500);
  }

  function validateContent() {
    const content = editor ? editor.getValue() : '';
    const statusEl = document.getElementById('validation-status');
    const messagesEl = document.getElementById('validation-messages');
    const errorMsgEl = document.getElementById('validation-error-message');

    if (!content.trim()) {
      statusEl.innerHTML = '<span class="badge badge-ghost badge-sm">Empty</span>';
      messagesEl.classList.add('hidden');
      return;
    }

    // Send to server for validation
    fetch('<%= validate_yaml_admin_salt_states_path %>', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
      },
      body: JSON.stringify({ content: content })
    })
      .then(response => response.json())
      .then(data => {
        if (data.valid) {
          statusEl.innerHTML = `
          <span class="badge badge-success badge-sm gap-1">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            Valid YAML
          </span>`;
          messagesEl.classList.add('hidden');
        } else {
          statusEl.innerHTML = `
          <span class="badge badge-error badge-sm gap-1">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            Error
          </span>`;
          errorMsgEl.textContent = `Line ${data.line}: ${data.error}`;
          messagesEl.classList.remove('hidden');
        }
      })
      .catch(() => {
        statusEl.innerHTML = '<span class="badge badge-ghost badge-sm">Validation failed</span>';
      });
  }

  // Quick snippets
  const snippets = {
    pkg: `# Install packages
install_packages:
  pkg.installed:
    - pkgs:
      - package1
      - package2`,
    service: `# Manage service
my_service:
  service.running:
    - name: service_name
    - enable: True`,
    file: `# Manage file
/path/to/file:
  file.managed:
    - source: salt://path/to/source
    - user: root
    - group: root
    - mode: 644`,
    cmd: `# Run command
run_command:
  cmd.run:
    - name: 'echo hello'
    - unless: test -f /some/file`,
    user: `# Create user
my_user:
  user.present:
    - name: username
    - shell: /bin/bash
    - home: /home/username`
  };

  function insertSnippet(type) {
    if (editor && snippets[type]) {
      const position = editor.getPosition();
      editor.executeEdits('', [{
        range: new monaco.Range(position.lineNumber, position.column, position.lineNumber, position.column),
        text: '\n' + snippets[type] + '\n'
      }]);
      editor.focus();
    }
  }

  // Update file path preview based on name and type
  document.querySelector('input[name="salt_state[name]"]')?.addEventListener('input', updateFilePathPreview);
  document.getElementById('state_type_select')?.addEventListener('change', updateFilePathPreview);

  function updateFilePathPreview() {
    const name = document.querySelector('input[name="salt_state[name]"]').value || '...';
    const type = document.getElementById('state_type_select').value;
    let path;

    switch (type) {
      case 'state':
        path = `/srv/salt/${name}.sls`;
        break;
      case 'pillar':
        path = `/srv/pillar/${name}.sls`;
        break;
      case 'orchestration':
        path = `/srv/salt/orch/${name}.sls`;
        break;
      case 'cloud_profile':
        path = `/etc/salt/cloud.profiles.d/${name}.conf`;
        break;
      case 'cloud_provider':
        path = `/etc/salt/cloud.providers.d/${name}.conf`;
        break;
      case 'cloud_map':
        path = `/etc/salt/cloud.maps.d/${name}.map`;
        break;
      default:
        path = `/srv/salt/${name}.sls`;
    }

    document.getElementById('file-path-preview').textContent = path;
  }
</script>
