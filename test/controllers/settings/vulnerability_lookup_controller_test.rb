# frozen_string_literal: true

require 'test_helper'

module Settings
  class VulnerabilityLookupControllerTest < ActionDispatch::IntegrationTest
    setup do
      @admin = users(:admin)
      sign_in @admin
    end

    # Test Group 1.1: Tests for python_info endpoint (which calls get_python_environment_info)

    test 'python_info returns success with version when Python and PyVulnerabilityLookup installed' do
      python_path = '/opt/veracity/app/integrations_venv/bin/python'

      # Stub at instance level using any_instance
      Settings::VulnerabilityLookupController.any_instance.stubs(:get_python_environment_info).returns({
        available: true,
        python_path: python_path,
        python_version: '3.9.0',
        pyvulnerabilitylookup_version: '1.2.3',
        message: 'Python environment is configured correctly'
      })

      post settings_vulnerability_lookup_python_info_path

      assert_response :success
      json_response = JSON.parse(response.body)

      assert json_response['success']
      assert_equal '1.2.3', json_response['pyvulnerabilitylookup_version']
      assert_equal python_path, json_response['python_path']
      assert_match(/configured correctly/, json_response['message'])
    end

    test 'python_info returns failure with clear error when PyVulnerabilityLookup not installed' do
      python_path = '/opt/veracity/app/integrations_venv/bin/python'

      Settings::VulnerabilityLookupController.any_instance.stubs(:get_python_environment_info).returns({
        available: false,
        python_path: python_path,
        python_version: '3.9.0',
        pyvulnerabilitylookup_version: nil,
        message: 'PyVulnerabilityLookup is not installed. Run: pip install pyvulnerabilitylookup'
      })

      post settings_vulnerability_lookup_python_info_path

      assert_response :success
      json_response = JSON.parse(response.body)

      assert_not json_response['success']
      assert_nil json_response['pyvulnerabilitylookup_version']
      assert_match(/PyVulnerabilityLookup is not installed/, json_response['message'])
      assert_match(/pip install pyvulnerabilitylookup/, json_response['message'])
    end

    test 'python_info uses fallback path when configured path is invalid' do
      venv_path = '/opt/veracity/app/integrations_venv/bin/python'

      Settings::VulnerabilityLookupController.any_instance.stubs(:get_python_environment_info).returns({
        available: true,
        python_path: venv_path,
        python_version: '3.9.0',
        pyvulnerabilitylookup_version: '1.2.3',
        message: 'Python environment is configured correctly'
      })

      post settings_vulnerability_lookup_python_info_path

      assert_response :success
      json_response = JSON.parse(response.body)

      assert_equal venv_path, json_response['python_path']
      assert json_response['success']
    end

    test 'python_info handles timeout gracefully' do
      Settings::VulnerabilityLookupController.any_instance.stubs(:get_python_environment_info).returns({
        available: false,
        python_path: '/opt/veracity/app/integrations_venv/bin/python',
        python_version: nil,
        pyvulnerabilitylookup_version: nil,
        message: 'Python environment check timed out. Please check system load and try again.'
      })

      post settings_vulnerability_lookup_python_info_path

      assert_response :success
      json_response = JSON.parse(response.body)

      assert_not json_response['success']
      assert_match(/timed out/i, json_response['message'])
    end

    test 'python_info handles execution errors gracefully' do
      Settings::VulnerabilityLookupController.any_instance.stubs(:get_python_environment_info).returns({
        available: false,
        python_path: '/opt/veracity/app/integrations_venv/bin/python',
        python_version: nil,
        pyvulnerabilitylookup_version: nil,
        message: 'Python environment error: Execution failed'
      })

      post settings_vulnerability_lookup_python_info_path

      assert_response :success
      json_response = JSON.parse(response.body)

      assert_not json_response['success']
      assert_match(/Execution failed/, json_response['message'])
    end

    # ===========================================
    # Task Group 4: Strategic Coverage Gap Tests
    # ===========================================

    test 'python_info handles JSON parse error from malformed Python output' do
      Settings::VulnerabilityLookupController.any_instance.stubs(:get_python_environment_info).returns({
        available: false,
        python_path: '/opt/veracity/app/integrations_venv/bin/python',
        python_version: nil,
        pyvulnerabilitylookup_version: nil,
        message: 'Failed to parse Python script output. Error: SyntaxError: invalid syntax'
      })

      post settings_vulnerability_lookup_python_info_path

      assert_response :success
      json_response = JSON.parse(response.body)

      assert_not json_response['success']
      assert_nil json_response['pyvulnerabilitylookup_version']
      assert_match(/Failed to parse Python script output/, json_response['message'])
    end

    test 'python_info returns clear error when all Python paths fail' do
      Settings::VulnerabilityLookupController.any_instance.stubs(:get_python_environment_info).returns({
        available: false,
        python_path: nil,
        python_version: nil,
        pyvulnerabilitylookup_version: nil,
        message: 'Python not configured or missing. Please set Python path in settings.'
      })

      post settings_vulnerability_lookup_python_info_path

      assert_response :success
      json_response = JSON.parse(response.body)

      assert_not json_response['success']
      assert_nil json_response['python_path']
      assert_nil json_response['python_version']
      assert_nil json_response['pyvulnerabilitylookup_version']
      assert_match(/Python not configured or missing/, json_response['message'])
      assert_match(/Please set Python path in settings/, json_response['message'])
    end

    test 'python_info handles permission denied errors gracefully' do
      Settings::VulnerabilityLookupController.any_instance.stubs(:get_python_environment_info).returns({
        available: false,
        python_path: '/opt/veracity/app/integrations_venv/bin/python',
        python_version: nil,
        pyvulnerabilitylookup_version: nil,
        message: 'Python environment error: Permission denied - /opt/veracity/app/integrations_venv/bin/python'
      })

      post settings_vulnerability_lookup_python_info_path

      assert_response :success
      json_response = JSON.parse(response.body)

      assert_not json_response['success']
      assert_match(/Python environment error/, json_response['message'])
      assert_match(/Permission denied/, json_response['message'])
    end

    # Test the actual exception handling in python_info action
    test 'python_info action handles unexpected exceptions' do
      Settings::VulnerabilityLookupController.any_instance.stubs(:get_python_environment_info).raises(StandardError.new('Unexpected error'))
      Rails.logger.stubs(:error)

      post settings_vulnerability_lookup_python_info_path

      assert_response :unprocessable_entity
      json_response = JSON.parse(response.body)

      assert_not json_response['success']
      assert_match(/Failed to get Python info/, json_response['message'])
    end
  end
end
