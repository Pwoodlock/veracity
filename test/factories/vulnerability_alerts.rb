# frozen_string_literal: true

FactoryBot.define do
  factory :vulnerability_alert do
    sequence(:cve_id) { |n| "CVE-2024-#{n.to_s.rjust(5, '0')}" }
    status { "new" }
    severity { "MEDIUM" }
    description { "A vulnerability has been discovered that allows..." }
    published_at { 1.week.ago }

    trait :new do
      status { "new" }
      acknowledged_at { nil }
      resolved_at { nil }
    end

    trait :acknowledged do
      status { "acknowledged" }
      acknowledged_at { 1.day.ago }
      acknowledged_by { "admin@example.com" }
    end

    trait :investigating do
      status { "investigating" }
      acknowledged_at { 2.days.ago }
      acknowledged_by { "admin@example.com" }
    end

    trait :patched do
      status { "patched" }
      resolved_at { Time.current }
      resolved_by { "admin@example.com" }
    end

    trait :ignored do
      status { "ignored" }
      resolved_at { Time.current }
      resolved_by { "admin@example.com" }
      notes { "Ignored: Not applicable to our configuration" }
    end

    trait :critical do
      severity { "CRITICAL" }
      cvss_score { 9.8 }
      cvss_vector { "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H" }
    end

    trait :high do
      severity { "HIGH" }
      cvss_score { 8.1 }
      cvss_vector { "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:N" }
    end

    trait :medium do
      severity { "MEDIUM" }
      cvss_score { 5.5 }
      cvss_vector { "CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:N/A:N" }
    end

    trait :low do
      severity { "LOW" }
      cvss_score { 2.5 }
      cvss_vector { "CVSS:3.1/AV:L/AC:H/PR:H/UI:R/S:U/C:L/I:N/A:N" }
    end

    trait :info do
      severity { "INFO" }
      cvss_score { nil }
    end

    trait :exploited do
      is_exploited { true }
      has_patch { false }
    end

    trait :with_patch do
      has_patch { true }
      solution { "Update to version 2.0.0 or later" }
    end

    trait :with_epss do
      epss_score { 0.45 }
    end

    trait :overdue do
      severity { "CRITICAL" }
      status { "new" }
      published_at { 2.weeks.ago }
    end

    trait :with_server do
      association :server
    end

    trait :with_watchlist do
      association :cve_watchlist
    end

    trait :global do
      server { nil }
    end

    trait :with_vulnerability_data do
      vulnerability_data do
        {
          "cvss" => {
            "base_score" => 7.5,
            "attack_vector" => "NETWORK",
            "attack_complexity" => "LOW"
          },
          "references" => [
            "https://nvd.nist.gov/vuln/detail/CVE-2024-00001"
          ],
          "cwe_ids" => ["CWE-79"],
          "affected_products" => ["product:1.0.0"]
        }
      end
    end
  end
end
