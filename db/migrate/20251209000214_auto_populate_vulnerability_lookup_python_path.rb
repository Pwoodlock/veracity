# frozen_string_literal: true

# Migration to auto-populate the vulnerability_lookup_python_path SystemSetting
# when the Python virtual environment exists at the standard installation path.
#
# This ensures fresh installations and upgrades automatically have the Python path
# configured without requiring manual administrator intervention.
#
# IMPORTANT: This migration is idempotent and safe to run multiple times.
# It will NOT override existing custom Python path configurations.
class AutoPopulateVulnerabilityLookupPythonPath < ActiveRecord::Migration[8.0]
  VENV_PYTHON_PATH = '/opt/veracity/app/integrations_venv/bin/python'
  SETTING_KEY = 'vulnerability_lookup_python_path'

  def up
    # Only auto-populate if the venv Python exists on this system
    unless File.exist?(VENV_PYTHON_PATH)
      puts "Skipping auto-population: #{VENV_PYTHON_PATH} does not exist"
      return
    end

    # Check if setting already exists with a different value (custom configuration)
    existing_setting = SystemSetting.find_by(key: SETTING_KEY)

    if existing_setting && existing_setting.value != VENV_PYTHON_PATH
      # Don't override manually-configured custom paths
      puts "Skipping auto-population: #{SETTING_KEY} already configured with custom value: #{existing_setting.value}"
      return
    end

    # Create or update the setting using find_or_create_by! pattern
    SystemSetting.find_or_create_by!(key: SETTING_KEY) do |setting|
      setting.value = VENV_PYTHON_PATH
      setting.value_type = 'string'
    end

    puts "Auto-populated #{SETTING_KEY}: #{VENV_PYTHON_PATH}"
  end

  def down
    # Only remove the setting if it matches the auto-populated value
    # This preserves custom configurations during rollback
    setting = SystemSetting.find_by(key: SETTING_KEY, value: VENV_PYTHON_PATH)

    if setting
      setting.destroy
      puts "Removed auto-populated #{SETTING_KEY}: #{VENV_PYTHON_PATH}"
    else
      puts "Skipping rollback: #{SETTING_KEY} was not auto-populated or has been modified"
    end
  end
end
